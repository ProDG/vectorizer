from unittest.mock import patch, AsyncMock

import pytest
from fastapi.testclient import TestClient

from app.core.config import settings
from app.main import app


client = TestClient(app)


@pytest.mark.asyncio
def test_vectorize_text_plain():
    text_vector_plain = {
        'vector': [
            0.18376368284225464, -0.015619166195392609, -0.13085918128490448, 0.3001229166984558,
            -0.1083759143948555, -0.3080921769142151, 0.11455249786376953, -1.691825032234192,
            -0.28878724575042725, -0.07458099722862244, -0.12123595178127289, -0.3845515251159668,
            -0.0840483009815216, 0.09754986315965652, 0.24105869233608246, -0.02545543760061264,
            0.5059897303581238, 0.08790174126625061, -0.12034472078084946, 0.039325617253780365,
            0.4047175645828247, -0.167923703789711, 0.12279240787029266, -0.08690182864665985,
            -0.3674170672893524, -0.4333072006702423, -0.09393732249736786, 0.21734175086021423,
            0.051215484738349915, 0.17866897583007812, -0.031073950231075287, -0.23048937320709229,
            -0.032259710133075714, -0.35255658626556396, 0.02927371859550476, 0.011056888848543167,
            -0.025046885013580322, -0.04467714577913284, -0.026412667706608772, 0.06694706529378891,
            -0.08405712991952896, -0.33286041021347046, -0.15464168787002563, 0.0980035588145256,
            0.056825339794158936, 0.15371763706207275, 0.07214970886707306, -0.1413118541240692,
            0.20016580820083618, 0.11843463778495789, 0.10146632790565491, -0.1710899919271469,
            -0.15385250747203827, -0.16366153955459595, 0.046707883477211, -0.07657528668642044,
            0.03404771536588669, -0.05718245357275009, -0.19598445296287537, -0.14481601119041443,
            0.40195441246032715, -0.014543760567903519, 0.2889021039009094, -0.09236934781074524,
            0.22553597390651703, -0.20765912532806396, 0.1493685096502304, -0.23904438316822052,
            -0.02803618088364601, 0.11319798231124878, -0.01770283281803131, -0.10901789367198944,
            -0.1371135264635086, -0.04730100929737091, 0.1670062094926834, -0.40169546008110046,
            0.09640423953533173, 0.5391308069229126, -0.19198834896087646, -0.22438332438468933,
            0.10872442275285721, -0.21575811505317688, -0.3799118399620056, -0.06537298858165741,
            -0.16572408378124237, -0.06101899594068527, -0.07793597877025604, -0.10980434715747833,
            -0.033793337643146515, 0.04108523204922676, 0.2529681921005249, 0.1991618573665619,
            -2.0000784397125244, 0.12113210558891296, 0.10184885561466217, -0.03743956983089447,
            -0.14175532758235931, 0.1607379913330078, -0.022047951817512512, -0.04591410607099533,
            0.1280726194381714, 0.1716214418411255, 0.19971111416816711, 0.08030906319618225,
            0.10475562512874603, -0.01925347000360489, 0.4250199794769287, -0.17471064627170563,
            -0.06391283124685287, -0.11282337456941605, 0.09187466651201248, 0.3913207948207855,
            -0.06879128515720367, -0.0341387502849102, 0.05408000200986862, -0.2931744456291199,
            0.11843423545360565, 0.13827770948410034, -0.031311966478824615, -0.1640661656856537,
            0.30600273609161377, 0.10227778553962708, 0.004795193672180176, 0.22681966423988342,
            0.04990728199481964, -0.091443732380867, -0.008303508162498474, 0.02319347858428955,
            0.003492884337902069, -0.07702134549617767, 0.16653697192668915, 0.23429188132286072,
            0.038260262459516525, 8.008532524108887, -0.30406343936920166, 0.19971564412117004,
            0.07742243260145187, -0.44332852959632874, -0.019668832421302795, -0.06965746730566025,
            -0.012988701462745667, -0.09310030192136765, -0.06408767402172089, 0.11284060776233673,
            -0.17782574892044067, 0.06505605578422546, -0.38436007499694824, 0.23253832757472992,
            0.17216207087039948, 0.18623018264770508, 0.22532427310943604, -0.10012558102607727,
            -0.3350904583930969, -0.14607855677604675, 0.23696762323379517, -0.18415501713752747,
            -0.1855410933494568, -0.016774296760559082, -0.42405617237091064, -0.15013724565505981,
            -0.353267639875412, 0.027476411312818527, -0.09963613748550415, 0.041225139051675797,
            -0.00314924493432045, -0.05406923592090607, 0.21527309715747833, 0.046828463673591614,
            0.14626580476760864, -0.04473979026079178, 0.026708371937274933, 0.018643943592905998,
            0.0060880593955516815, 0.1057286262512207, -0.2612913250923157, 0.0005543529987335205,
            -0.35411977767944336, -0.11854840815067291, 0.08240439742803574, 0.12312276661396027,
            0.04439648240804672, 0.25284597277641296, 0.04760323464870453, 0.16173487901687622,
            -0.2009381353855133, 0.10273271799087524, 0.13162146508693695, -0.06871899962425232,
            0.22774869203567505, -0.21069911122322083, 0.14596126973628998, -0.18826496601104736,
            0.19003695249557495, 0.2589579224586487, 0.16595172882080078, 0.15110628306865692,
            -0.21617373824119568, 0.12307301163673401, -0.18999327719211578, 0.1304672658443451,
            0.03910680115222931, -0.300896018743515, 0.07750508189201355, 0.15796351432800293,
            0.25707098841667175, -0.12801872193813324, -0.07838462293148041, 0.04927663505077362,
            -0.0024566277861595154, 0.17107632756233215, 0.17090767621994019, -0.01655178889632225,
            -0.023207642138004303, 0.13520756363868713, -0.23913361132144928, -0.11338087916374207,
            -0.14829617738723755, -0.17752066254615784, 0.374203085899353, -0.26853975653648376,
            0.07801365107297897, -0.016928527504205704, -0.03585750609636307, -0.1364593356847763,
            0.1938735544681549, -0.059508178383111954, -0.27882397174835205, 0.4825720191001892,
            0.038826920092105865, -0.022501736879348755, -0.15326546132564545, 0.22303014993667603,
            -0.04562438279390335, 0.2760910093784332, 0.14938999712467194, -0.0368255190551281,
            0.036150798201560974, 0.027919486165046692, -0.08623704314231873, -0.03786543384194374,
            -0.09807601571083069, 0.07497479021549225, 0.10715648531913757, -0.390476793050766,
            -0.0828615128993988, 0.3784312903881073, 0.14323869347572327, -0.28787362575531006,
            -0.02967230975627899, -0.15804044902324677, -0.0916980654001236, -0.005024798214435577,
            0.07032240182161331, -0.19706808030605316, -0.20092663168907166, -0.014033980667591095,
            0.05756846070289612, 0.08212315291166306, 0.2234327793121338, 0.08160541951656342,
            0.13038726150989532, -0.2251664400100708, -0.1353585124015808, 0.03743460774421692,
            -0.21279028058052063, 0.21366026997566223, -0.03055015578866005, -0.29030102491378784,
            0.11234885454177856, -0.1168634444475174, 0.04994674026966095, -0.17314426600933075,
            0.052399955689907074, 0.16844531893730164, -0.013434186577796936, -0.17647099494934082,
            -0.19886860251426697, 0.18337321281433105, -0.16701959073543549, 0.05584205687046051,
            0.2776264548301697, -0.024499140679836273, 0.1637648046016693, -0.2009499967098236,
            0.1991395652294159, 0.28733617067337036, 0.10341361910104752, -0.040001124143600464,
            0.014915503561496735, -0.016201689839363098, 0.2650221586227417, 0.10623215138912201,
            0.24391311407089233, 0.07186012715101242, 0.11436070501804352, 0.13732150197029114,
            -0.23075856268405914, -0.44537031650543213, 0.17203521728515625, -0.05904050171375275,
            0.14246311783790588, -0.29383108019828796, 0.3161662220954895, 0.02833329141139984,
            0.27521026134490967, 0.43285033106803894, -0.3770746886730194, -0.12678170204162598,
            -0.058887988328933716, 0.004352770745754242, 0.3384205400943756, -0.016829807311296463,
            7.996703147888184, -0.1286516636610031, 0.18729624152183533, 0.17964525520801544,
            -0.14307549595832825, -0.024378560483455658, -0.10995739698410034, 0.10071229934692383,
            0.27264299988746643, 0.48043203353881836, -0.07088039815425873, 0.126202791929245,
            0.08843214064836502, -0.032182544469833374, -0.043466925621032715, -0.05693630501627922,
            -0.14992770552635193, -3.232377290725708, -0.117589071393013, -0.21657103300094604,
            -0.023064881563186646, -0.014502286911010742, 0.31044885516166687, -0.21147702634334564,
            -0.003087744116783142, 0.12997664511203766, 0.1307143270969391, 0.028442271053791046,
            0.023855775594711304, 0.22252725064754486, 0.29169827699661255, 0.01907135546207428,
            -0.15907928347587585, -0.01993325725197792, -0.04567258059978485, 0.12667304277420044,
            0.03619983419775963, -0.039721835404634476, 0.11933582276105881, -0.025418691337108612,
            0.07885163277387619, 0.22450116276741028, -0.10250422358512878, 0.44710272550582886,
            0.058823361992836, 0.2965198755264282, 0.09231211245059967, -0.27528923749923706,
            0.038374386727809906, 0.1888456791639328, 0.557108998298645, 0.3318772614002228,
            0.019794106483459473, 0.03272958844900131, 0.19784845411777496, 0.1072424054145813,
            -0.1705847680568695, 0.2346445620059967, -0.033351000398397446, 0.2217099368572235,
            -0.050870440900325775, 0.08587992191314697, -0.05803923308849335, -0.00346263125538826,
            -0.14223000407218933, 0.08009538799524307, -0.39897865056991577, 0.16215640306472778,
            0.02964739501476288, -0.2785930633544922, 0.12464039027690887, 0.020101524889469147,
            0.260422945022583, -0.005149245262145996, -0.17379948496818542, -0.07089144736528397,
            -0.12643462419509888, 0.11881838738918304, -0.1371169090270996, -0.5040999054908752,
            -0.21960324048995972, 0.09389759600162506, 0.019594706594944, 0.008058525621891022,
            0.19046492874622345, 0.04291540011763573, -0.3154181241989136, 0.30726513266563416,
            0.19368115067481995, 0.11536887288093567, -0.02188940905034542, 0.12087644636631012,
            0.031153425574302673, 0.09454881399869919, -0.08152198791503906, 0.09138911217451096,
            0.117561474442482, 0.038627881556749344, 0.053086765110492706, 0.276685893535614,
            -0.008312605321407318, -0.05789440870285034, 0.22744381427764893, 0.20268622040748596,
            -0.027944885194301605, 0.25396355986595154, -0.007996469736099243, 0.06994715332984924,
            0.1219271719455719, -0.004595570266246796, 0.11777380853891373, -0.15752460062503815,
            -0.17891395092010498, 0.15924587845802307, -0.268311083316803, -0.024210231378674507,
            0.038819946348667145, 0.1495082974433899, -0.0913688987493515, 0.09480248391628265,
            -0.224664106965065, -0.08001849055290222, 0.04920883849263191, 0.13495968282222748,
            -0.02607974410057068, -0.4655107259750366, -0.030814796686172485, 0.03322087228298187,
            0.15829750895500183, 0.04504705220460892, 0.1437450498342514, -0.22274255752563477,
            -0.017071425914764404, -0.0927271768450737, 0.05829311162233353, 0.023456990718841553,
            -0.003271356225013733, 0.10808318853378296, 0.027214348316192627, -0.01908552646636963,
            -0.0929637923836708, 0.4077870845794678, 0.27536851167678833, 0.1383754462003708,
            0.016690969467163086, 0.24108965694904327, -0.09492231905460358, 0.1204543337225914,
            0.19369164109230042, -0.34288322925567627, 0.05058498680591583, 0.21566054224967957,
            -0.013218171894550323, -0.07362944632768631, 0.11280328035354614, 0.05692243576049805,
            -0.2033059298992157, 0.1764167845249176, -0.10812151432037354, 0.08008477836847305,
            -0.062115736305713654, -0.20856264233589172, 0.1362476348876953, 0.2180979996919632,
            0.04048280417919159, 0.36615604162216187, 0.1539134532213211, 0.14674416184425354,
            0.18459239602088928, -0.828627347946167, 0.08559751510620117, -0.04576948285102844,
            -0.36779946088790894, -0.17555348575115204, -0.18941371142864227, 0.02141764760017395,
            -0.22519537806510925, 0.12894947826862335, -0.21388965845108032, 0.059605881571769714,
            0.016522228717803955, 0.2221875637769699, -0.04864419251680374, -0.00818582996726036,
            -0.16563622653484344, -0.19260390102863312, 0.1703992486000061, 0.02584589645266533,
            -0.20760983228683472, -0.0816386342048645, 0.2996702790260315, 0.10816885530948639,
            -0.09002815932035446, 0.09526929259300232, -0.01983317732810974, -0.1250075101852417,
            -0.09035424888134003, -0.5438652038574219, -0.1629963517189026, 0.33151891827583313
        ],
        'exec_time': 2.1845,
        'model': 'clip-ViT-B-32-multilingual-v1',
        'device': 'cpu'
    }

    with patch('app.api.routers.vectorize_routers.vectorize_content', new_callable=AsyncMock) as mock:
        mock.return_value = text_vector_plain
        response = client.post(
            '/api/vectorize/{model_code}/text/'.format(
                model_code='clip-ViT-B-32-multilingual-v1'
            ),
            headers={
                'Authorization': f'Bearer {settings.auth_token}'
            },
            json={
                'src_text': "Hello!"
            }
        )

    assert response.status_code == 201
    assert response.json() == text_vector_plain


@pytest.mark.asyncio
def test_vectorize_text_encoded_bytes():
    text_vector_encoded_bytes = {
        'vector': 'jCw8Pojnf7zz/wW+tqmZPjH03b1Cvp2+gJrqPbmN2L/s25O+7L2YvY5K+L3w48S+hCGsvTnIxz0X2HY+7IfQvIuIAT/UBb'
                  'Q9S3f2veYTIT0kN88+MfQrvpZ6+z2W+bG9Fx68vnHa3b42YsC91o5ePlTHUT0A9TY+zI7+vGgFbL7CIgS9TIK0vnDP7zz0'
                  'JzU8IC/NvGL/Nr1hX9i8ixuJPSUmrL2ubKq+ZFoevhe2yD2wwWg9KGgdPjrDkz0OtBC+RPhMPtyN8j2Uzc89NzIvvoOLHb'
                  '7klie+xFA/PYHTnL2edQs9JjhqvSawSL6mShS++MzNPvRIbrz66pM+JCy9vefyZj6YpFS+D/QYPg3IdL4irOW8WNTnPYgF'
                  'kbzGRN+9fWcMvrS+Qb2tAys+B6vNvpZvxT16BAo/mJhEvr7EZb7pqt49su9cvs6Dwr5G4oW9k7Mpvg7veb3mnJ+9GuHgve'
                  'JqCr39SCg9DIWBPhbxSz5JAQDAHBT4PSKW0D08Whm9TygRvoCYJD7onbS8bhA8vXglAz6IvS8+EoFMPhR5pD0eitY9dLmd'
                  'vDic2T5Z5zK+u+SCvfEP573JKLw9M1vIPnLijL0T1Qu9/oJdPfYalr6mjfI9rJgNPvpAAL32ACi+ZKycPgR30T0AIZ07ak'
                  'NoPpRrTD3aRru9cAsIvEAAvjzg6GQ7Xr2dvauIKj426m8+y7YcPfMiAEE0rpu+QoJMPqePnj31++K+iCChvJOojr2QzlS8'
                  'X6u+vWZAg736GOc99Bc2vhw8hT3YysS+hx5uPkFLMD4gsz4+aLtmPqQOzb36kKu+npUVvqSncj4ikzy+fP49vkBqibzkHd'
                  'm+lL0Zvn/ftL42FuE8CA7MvbHbKD2QY067tHddvY1wXD40zz89tMYVPhJBN72Ey9o8L7uYPFh+xztAiNg9+seFvgBSETow'
                  'T7W+gsnyvaPDqD3KJ/w9Ftk1PQd1gT6c+0I91J0lPrrCTb6IZdI9x8cGPoy8jL30Nmk+gsFXvt92FT6IyEC+DJlCPiKWhD'
                  '5A7yk+m7saPqZcXb60Dfw9mY1CvjaZBT50LiA9Cw+avvy6nj0wwSE+z56DPlcXA74eiKC9TNZJPWD/ILuiLi8+bAIvPp6X'
                  'h7z0Hb682nMKPnHfdL48NOi99NoXvvrHNb6Ml78+C36Jvp/Fnz2yrYq8Ut8Svf+7C77KhkY+2b5zvQTCjr6uE/c++ggfPZ'
                  'BVuLyf8Ry+BGJkPqLgOr3NW40+sfkYPlvWFr3cEhQ9aLfkPAydsL3JGBu9FNzIvWKMmT3cdNs9k+zHvkyzqb2/wcE+Kq0S'
                  'Pixkk75YE/O8W9UhvjLMu70Qp6S7MQWQPTfMSb62v02+yO5lvOjMaz0vMKg9kMtkPr4gpz09hAU+CJJmvmybCr4IVRk9su'
                  'VZvsLJWj5SRPq8VqKUvigX5j0aVu+99JRMPbtMMb5WoVY97nwsPhAbXLzQtDS+NqRLvjDGOz4vByu+pLpkPQ4ljj5sssi8'
                  '9rEnPtbFTb4+60s+uh2TPoXK0z042CO9KGB0PGi5hLz8sIc+PpDZPVzEeT5nK5M98jXqPQKeDD75S2y+lAfkvgAqMD501H'
                  'G92uERPgdxlr6K4KE+OBvoPFzojD6Pnt0+7w/BvhDTAb6INHG9sKGOO3VFrT6q3om8/uT/QEO9A76Wyj8+7fQ3PmKCEr6M'
                  'tce8WDHhvUBCzj3dl4s+MPv1Pr4pkb1OOwE+6Ru1PdjRA71gCjK9CzZpvaaGGb5F307AitLwvczEXb6Q8ry8AJttvCfznj'
                  '5vjVi+wFtKu5kYBT762QU+xP/oPDBtwzwv3mM+elmVPog7nDyu5SK+EkujvCwTO72UtgE+R0YUPV2zIr1XZvQ93DrQvPd8'
                  'oT2i42U+vO3Rvabq5D7E8HA9dNGXPiIOvT228oy+di4dPcNgQT6yng4/0eupPkAnojx2DwY9yZhKPuih2z3GrS6+qkZwPg'
                  '+bCL3uB2M+hl1QvdDhrz2Mum29UO1iu76kEb4NCaQ97kbMvlQMJj4Y3/I8wKOOvnZD/z30q6Q8KFaFPgC7qLt++DG+iS+R'
                  'vRR4Ab4OV/M9YGgMvrEMAb+s32C+Yk3APRSFoDzoBwQ8PQlDPg/ILz18fqG+21GdPlpURj6ERuw9a1GzvBKO9z14Nf88z6'
                  'LBPQD1pr03Krs9EsTwPUU4Hj2CcVk9xqmNPpgxCLywIm29COdoPvqMTz6s7OS8gweCPqADA7x0QI899LT5PXCWlrtlM/E9'
                  'IU4hvjg1N75aESM+EmCJvolUxryqAR89tBgZPp4fu73OJ8I9WQ5mvrzgo701j0k93zIKPjCl1bxsV+6+UG/8vJwSCD2+GC'
                  'I+QoM4PecxEz6gFmS+YNmLvL/nvb3CxG494CjAPEBkVru4Wt09oPDePEBZnLzNY769eMnQPhr9jD5Lsg0+gLuIPDXgdj6i'
                  'ZsK9w7D2PRpXRj5kjq++NDJPPR7WXD4IkVi8CcuWvWgF5z2AJ2k9bi9QvpqmND7Qbt29fQOkPRJtfr1ykVW+gIQLPhVVXz'
                  '5M0SU9zni7Pn2bHT4aRBY+ygU9PuwgVL/ATa89yHg7vTZQvL5LxDO+q/VBvhB0rzyemWa+VQsEPuQFW75MJXQ9oFmHPCOF'
                  'Yz4iP0e93B0GvIucKb71OUW+JH0uPsa60zysl1S+KDKnvWJumT6ih909r2C4vYwcwz0weaK8+AEAvqYLub3AOgu/hOgmvt'
                  'm8qT4=',
        'exec_time': 1.9341391670168377,
        'model': 'clip-ViT-B-32-multilingual-v1',
        'device': 'cpu'
    }

    with patch('app.api.routers.vectorize_routers.vectorize_content', new_callable=AsyncMock) as mock:
        mock.return_value = text_vector_encoded_bytes
        response = client.post(
            '/api/vectorize/{model_code}/text/?mode=encoded_bytes'.format(
                model_code='clip-ViT-B-32-multilingual-v1'
            ),
            headers={
                'Authorization': f'Bearer {settings.auth_token}'
            },
            json={
                'src_text': "Hello!"
            }
        )

    assert response.status_code == 201
    assert response.json() == text_vector_encoded_bytes
